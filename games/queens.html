<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Queens - Bulmaca Super App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/confetti.css">
    <script src="../js/theme.js"></script>
    <script src="../js/sound.js"></script>
    <script src="../js/i18n.js"></script>
    <style>
        .queens-board {
            display: grid;
            gap: 2px;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px;
            border-radius: 12px;
            border: 2px solid var(--border);
            margin: 0 auto;
            user-select: none;
        }

        .cell {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            cursor: pointer;
            position: relative;
        }

        /* Region colors */
        .region-0 {
            background: #4a2b38;
        }

        .region-1 {
            background: #2b384a;
        }

        .region-2 {
            background: #384a2b;
        }

        .region-3 {
            background: #4a3f2b;
        }

        .region-4 {
            background: #3a2b4a;
        }

        .region-5 {
            background: #2b4a44;
        }

        .region-6 {
            background: #4a2b2b;
        }

        .region-7 {
            background: #333333;
        }

        .cell.has-queen::after {
            content: '👑';
            animation: pop 0.2s;
        }

        .cell.marked::after {
            content: '✕';
            color: rgba(255, 255, 255, 0.2);
            font-size: 1.2rem;
        }

        .cell.conflict {
            box-shadow: inset 0 0 0 2px #ef4444;
            background: rgba(239, 68, 68, 0.2);
        }

        @keyframes pop {
            0% {
                transform: scale(0);
            }

            80% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .controls-hint {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 15px;
        }
    </style>
</head>

<body>

    <header class="game-header">
        <a href="../index.html" class="back-btn">←</a>
        <div class="game-title-bar">
            <h1>👑 Queens</h1>
        </div>
        <div class="game-actions">
            <button class="action-btn" onclick="openTutorial()">❓</button>
            <button class="action-btn" onclick="game.reset()" title="Sıfırla" data-i18n-title="btn_reset">🔄</button>
        </div>
    </header>

    <main class="game-container">
        <div class="mode-selector">
            <button id="btn-random" class="mode-btn random active" onclick="game.newGame('random')"
                data-i18n="btn_random">🎲 Rastgele</button>
            <button id="btn-daily" class="mode-btn daily" onclick="game.newGame('daily')" data-i18n="btn_daily">📅
                Günlük</button>
        </div>
        <!-- Daily Mode Badge -->
        <div id="daily-badge" class="daily-mode-badge" style="display: none;" data-i18n="daily_puzzle_badge">📅 GÜNLÜK
            BULMACA</div>

        <div class="level-selector">
            <button id="lvl-5" class="level-btn active" onclick="game.setLevel(5)">5×</button>
            <button id="lvl-6" class="level-btn" onclick="game.setLevel(6)">6×</button>
            <button id="lvl-7" class="level-btn" onclick="game.setLevel(7)">7×</button>
            <button id="lvl-8" class="level-btn" onclick="game.setLevel(8)">8×</button>
        </div>

        <div class="game-info">
            <div class="info-item">
                <div class="info-value" id="queensCount">0/5</div>
                <div class="info-label" data-i18n="label_queen">Vezir</div>
            </div>
        </div>

        <div class="queens-board" id="board"></div>
        <div class="controls-hint"><span data-i18n="hint_click_queen">👆 Tıkla: Vezir koy</span><br><span
                data-i18n="hint_dblclick_x">❌ Çift Tıkla: 'X' koy</span></div>
    </main>

    <!-- TUTORIAL -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-modal">
            <h2 data-i18n="tutorial_title">Nasıl Oynanır?</h2>
            <ul class="tutorial-steps">
                <li data-i18n="tut_queens_1">Her <strong>satıra</strong>, her <strong>sütuna</strong> ve her
                    <strong>renkli bölgeye</strong> 1
                    Vezir (👑) koy.
                </li>
                <li data-i18n="tut_queens_2">Vezirler birbirine <strong>çaprazdan bile</strong> değemez.</li>
                <li data-i18n="tut_queens_3">Kareye tıkla: Vezir koy.</li>
                <li data-i18n="tut_queens_4">Çift tıkla: 'X' koy (Boş olduğunu işaretle).</li>
            </ul>
            <button class="win-btn" onclick="closeTutorial()" data-i18n="btn_understood">Anladım</button>
        </div>
    </div>

    <div class="win-overlay" id="winOverlay">
        <div class="win-modal" style="padding: 2rem; text-align: center;">
            <div class="win-icon">🎉</div>
            <div class="win-title" style="margin-bottom: 1.5rem;" data-i18n="congrats">Tebrikler!</div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="win-btn" onclick="game.next()"
                    style="background: #3b82f6; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none;"
                    data-i18n="btn_next_level">Sonraki
                    Bölüm</button>
                <button onclick="game.saveAndExit()"
                    style="background: #10b981; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; border: 2px solid white;"
                    data-i18n="btn_save_exit">💾 Kaydet ve Ana Menüye Dön</button>
            </div>
        </div>
    </div>

    <script>
        function openTutorial() { document.getElementById('tutorialOverlay').classList.add('show'); }
        function closeTutorial() { document.getElementById('tutorialOverlay').classList.remove('show'); localStorage.setItem('seen_tut_queen', 'true'); }
        if (!localStorage.getItem('seen_tut_queen')) setTimeout(openTutorial, 500);

        // ===== QUEENS GENERATOR (Endless) =====

        class QueensGame {
            constructor() {
                this.size = 5;
                this.board = [];
                this.regions = [];
                this.mode = 'random';
                this.boardEl = document.getElementById('board');
                this.init(5);
            }

            // Seeded random function
            mulberry32(a) {
                return function () {
                    let t = a += 0x6D2B79F5;
                    t = Math.imul(t ^ t >>> 15, t | 1);
                    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                    return ((t ^ t >>> 14) >>> 0) / 4294967296;
                }
            }

            newGame(mode) {
                this.mode = mode;

                // Update UI Buttons
                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                if (mode === 'daily') {
                    document.getElementById('btn-daily').classList.add('active');
                    document.getElementById('daily-badge').style.display = 'inline-flex';
                    const today = new Date();
                    const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
                    this.rng = this.mulberry32(seed);
                    document.getElementById('daily-badge').textContent = `📅 ${getText('daily_puzzle_badge')} #${seed % 1000}`;
                } else {
                    document.getElementById('btn-random').classList.add('active');
                    document.getElementById('daily-badge').style.display = 'none';
                    this.rng = Math.random;
                }
                this.init(this.size);
            }

            init(size) {
                this.size = size;
                this.generateLevel(size);
                this.reset();
            }

            generateLevel(size) {
                // 1. Place N Queens validly (Backtracking)
                const queens = this.solveNQueens(size);
                if (!queens) {
                    // Fallback if generation fails (rare for small N)
                    this.init(size);
                    return;
                }

                // 2. Generate Regions (Voronoi-like growth from Queens)
                this.regions = Array(size).fill(0).map(() => Array(size).fill(-1));

                // Seed regions at queen positions
                let queue = [];
                queens.forEach((q, i) => {
                    this.regions[q.y][q.x] = i; // Region ID = i
                    queue.push({ x: q.x, y: q.y, id: i });
                });

                // Random Flood Fill
                while (queue.length > 0) {
                    // Randomize queue pick to make regions organic
                    const idx = Math.floor((this.rng || Math.random)() * queue.length);
                    const { x, y, id } = queue[idx];
                    queue.splice(idx, 1);

                    const neighbors = [
                        { x: x + 1, y: y }, { x: x - 1, y: y }, { x: x, y: y + 1 }, { x: x, y: y - 1 }
                    ];

                    for (const n of neighbors) {
                        if (n.x >= 0 && n.x < size && n.y >= 0 && n.y < size && this.regions[n.y][n.x] === -1) {
                            this.regions[n.y][n.x] = id;
                            queue.push({ x: n.x, y: n.y, id: id });
                        }
                    }
                }

                // Fill any remaining holes (rare)
                for (let y = 0; y < size; y++) {
                    for (let x = 0; x < size; x++) {
                        if (this.regions[y][x] === -1) this.regions[y][x] = Math.floor((this.rng || Math.random)() * size);
                    }
                }
            }

            solveNQueens(n) {
                const board = Array(n).fill(-1); // board[col] = row
                const res = [];

                const solve = (col) => {
                    if (col === n) return true;

                    // Randomize row order
                    const rows = Array.from({ length: n }, (_, i) => i).sort(() => (this.rng || Math.random)() - 0.5);

                    for (const row of rows) {
                        if (this.isSafe(board, row, col)) {
                            board[col] = row;
                            if (solve(col + 1)) return true;
                            board[col] = -1;
                        }
                    }
                    return false;
                };

                if (solve(0)) {
                    for (let c = 0; c < n; c++) res.push({ x: c, y: board[c] });
                    return res;
                }
                return null;
            }

            isSafe(board, row, col) {
                for (let i = 0; i < col; i++) {
                    const prevRow = board[i];
                    if (prevRow === row) return false;
                    if (Math.abs(prevRow - row) === Math.abs(i - col)) return false;
                    // Check "One queen per color" constraint is handled by region generation later
                    // But we must also check "Cannot touch diagonally" rule of this game?
                    // The game rule says: "Vezirler birbirine çaprazdan bile değemez" (Kings move).
                    // Standard N-Queens checks diagonals globally.
                    // This specific game usually implies King's Move separation (touching), NOT global diagonal.
                    // BUT Standard N-Queens global diagonal constraint is STRONGER than King's move.
                    // So N-Queens solution is definitely valid for King's move.
                }
                return true;
            }

            setLevel(n) { document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); this.init(n); }
            reset() {
                this.board = Array(this.size).fill(0).map(() => Array(this.size).fill(0));
                this.render(); this.updateInfo();
                document.getElementById('winOverlay').classList.remove('show');
            }
            setLevel(n) { document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); this.init(n); }
            reset() {
                this.board = Array(this.size).fill(0).map(() => Array(this.size).fill(0));
                this.render(); this.updateInfo();
                document.getElementById('winOverlay').classList.remove('show');
            }
            render() {
                this.boardEl.style.gridTemplateColumns = `repeat(${this.size}, 48px)`;
                this.boardEl.innerHTML = '';
                for (let y = 0; y < this.size; y++) {
                    for (let x = 0; x < this.size; x++) {
                        const cell = document.createElement('div');
                        cell.className = `cell region-${this.regions[y][x]}`;
                        if (this.board[y][x] === 1) cell.classList.add('has-queen');
                        if (this.board[y][x] === 2) cell.classList.add('marked');
                        cell.onclick = () => this.click(x, y);
                        // Removed contextmenu/dblclick to simplify mobile controls as requested
                        cell.oncontextmenu = (e) => { e.preventDefault(); };
                        this.boardEl.appendChild(cell);
                    }
                }
                this.checkConflicts();
            }
            click(x, y) {
                // Tri-state toggle: Empty (0) -> Queen (1) -> Marked (2) -> Empty (0)
                if (this.board[y][x] === 0) {
                    this.board[y][x] = 1; // Place Queen
                } else if (this.board[y][x] === 1) {
                    this.board[y][x] = 2; // Mark X
                } else {
                    this.board[y][x] = 0; // Clear
                }

                this.render(); this.updateInfo(); this.checkWin();
            }
            mark(x, y) {
                if (this.board[y][x] === 2) this.board[y][x] = 0;
                else this.board[y][x] = 2;
                this.render();
            }
            checkConflicts() {
                const queens = [];
                for (let y = 0; y < this.size; y++) for (let x = 0; x < this.size; x++) if (this.board[y][x] === 1) queens.push({ x, y, r: this.regions[y][x] });
                const conflicts = new Set();
                queens.forEach(q1 => {
                    queens.forEach(q2 => {
                        if (q1 === q2) return;
                        if (q1.x === q2.x || q1.y === q2.y || q1.r === q2.r || (Math.abs(q1.x - q2.x) === 1 && Math.abs(q1.y - q2.y) === 1)) {
                            conflicts.add(`${q1.x},${q1.y}`); conflicts.add(`${q2.x},${q2.y}`);
                        }
                    });
                });
                this.boardEl.querySelectorAll('.cell').forEach((c, i) => {
                    if (conflicts.has(`${i % this.size},${Math.floor(i / this.size)}`)) c.classList.add('conflict');
                });
                return conflicts.size === 0;
            }
            updateInfo() { document.getElementById('queensCount').textContent = `${this.board.flat().filter(c => c === 1).length}/${this.size}`; }
            checkWin() {
                if (this.board.flat().filter(c => c === 1).length === this.size && this.checkConflicts()) {
                    // Session Tracking
                    if (!window.sessionWins) window.sessionWins = 0;
                    window.sessionWins++;
                    if (window.confetti) window.confetti.celebrate();
                    if (window.SoundManager) window.SoundManager.play('win');
                    setTimeout(() => document.getElementById('winOverlay').classList.add('show'), 300);
                }
            }
            next() {
                document.getElementById('winOverlay').classList.remove('show');
                if (this.size < 8) this.init(this.size + 1); else this.init(5);
            }
            saveAndExit() {
                const dailyParam = this.mode === 'daily' ? '&daily=true' : '';
                window.location.href = `../index.html?save=queens&wins=${window.sessionWins || 1}&time=0${dailyParam}`;
            }
        }
        const game = new QueensGame();
        window.game = game;
    </script>
    <script src="../js/confetti.js"></script>
</body>

</html>