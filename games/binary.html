<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Binary - Bulmaca Super App</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/confetti.css">
    <script src="../js/theme.js"></script>
    <script src="../js/sound.js"></script>
    <script src="../js/i18n.js"></script>
    <style>
        .binary-board {
            display: grid;
            gap: 2px;
            background: #222;
            padding: 4px;
            border-radius: 8px;
            margin: 0 auto;
            user-select: none;
        }

        .cell {
            width: 44px;
            height: 44px;
            background: #333;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background 0.1s;
        }

        .cell.fixed {
            background: #444;
            color: #888;
            pointer-events: none;
        }

        .cell.val-0 {
            color: #60a5fa;
        }

        .cell.val-1 {
            color: #f472b6;
        }

        .cell.error {
            box-shadow: inset 0 0 0 2px #ef4444;
        }

        .hint-text {
            text-align: center;
            color: #888;
            font-size: 0.9rem;
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <header class="game-header">
        <a href="../index.html" class="back-btn">←</a>
        <h1>0️⃣1️⃣ Binary</h1>
        <div class="game-actions">
            <button class="action-btn" onclick="openTutorial()">❓</button>
        </div>
    </header>

    <main class="game-container">
        <div class="mode-selector">
            <button id="btn-random" class="mode-btn random active" onclick="game.newGame('random')"
                data-i18n="btn_random">🎲 Rastgele</button>
            <button id="btn-daily" class="mode-btn daily" onclick="game.newGame('daily')" data-i18n="btn_daily">📅
                Günlük</button>
        </div>
        <!-- Daily Mode Badge -->
        <div id="daily-badge" class="daily-mode-badge" style="display: none;" data-i18n="daily_puzzle_badge">📅 GÜNLÜK
            BULMACA</div>
        <div class="binary-board" id="board"></div>
        <div class="hint-text" data-i18n="binary_rules">1. Yan yana en fazla iki aynı rakam.<br>2. Eşit sayıda 0 ve 1.
        </div>
    </main>

    <!-- TUTORIAL -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-modal">
            <h2 data-i18n="tutorial_title">Nasıl Oynanır?</h2>
            <ul class="tutorial-steps">
                <li data-i18n="tut_binary_1">Tüm kareleri <strong>0</strong> (Mavi) veya <strong>1</strong> (Pembe) ile
                    doldur.</li>
                <li data-i18n="tut_binary_2">Yan yana veya alt alta <strong>en fazla 2 tane</strong> aynı rakam
                    gelebilir.</li>
                <li data-i18n="tut_binary_3">Örneğin: 001 olabilir, ama 000 HATALIDIR.</li>
                <li data-i18n="tut_binary_4">Her satır ve sütunda <strong>eşit sayıda</strong> 0 ve 1 olmalıdır.</li>
            </ul>
            <button class="win-btn" onclick="closeTutorial()" data-i18n="btn_understood">Anladım</button>
        </div>
    </div>

    <div class="win-overlay" id="overlay">
        <div class="win-modal" style="padding: 2rem; text-align: center;">
            <h2 style="margin-bottom: 1.5rem;" data-i18n="congrats">Tebrikler!</h2>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="win-btn"
                    onclick="game.next(); document.getElementById('overlay').classList.remove('show');"
                    style="background: #3b82f6; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none;"
                    data-i18n="btn_next_level">Sonraki
                    Bölüm</button>
                <button onclick="game.saveAndExit()"
                    style="background: #10b981; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; border: 2px solid white;">💾
                    data-i18n="btn_save_exit">💾 Kaydet ve Ana Menüye Dön</button>
            </div>
        </div>
    </div>

    <script>
        function openTutorial() { document.getElementById('tutorialOverlay').classList.add('show'); }
        function closeTutorial() { document.getElementById('tutorialOverlay').classList.remove('show'); localStorage.setItem('seen_tut_binary', 'true'); }
        if (!localStorage.getItem('seen_tut_binary')) setTimeout(openTutorial, 500);

        // ===== BINARY GENERATOR (Endless) =====

        class BinaryGame {
            constructor() {
                this.size = 6;
                this.level = 0;
                this.mode = 'random';
                this.board = document.getElementById('board');
                this.init();
            }

            // Seeded random
            mulberry32(a) {
                return function () {
                    let t = a += 0x6D2B79F5;
                    t = Math.imul(t ^ t >>> 15, t | 1);
                    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                    return ((t ^ t >>> 14) >>> 0) / 4294967296;
                }
            }

            newGame(mode) {
                this.mode = mode;
                this.level = 0;

                // Update UI Buttons
                document.querySelectorAll('.action-btn').forEach(btn => {
                    if (btn.id) btn.classList.remove('active');
                });

                const btnRandom = document.getElementById('btn-random');
                const btnDaily = document.getElementById('btn-daily');

                if (mode === 'daily') {
                    btnDaily.classList.add('active');
                    document.getElementById('daily-badge').style.display = 'inline-flex';
                    const today = new Date();
                    const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
                    this.rng = this.mulberry32(seed);
                    document.getElementById('daily-badge').textContent = `📅 ${getText('daily_puzzle_badge')} #${seed % 1000}`;
                } else {
                    btnRandom.classList.add('active');
                    document.getElementById('daily-badge').style.display = 'none';
                    this.rng = Math.random;
                }
                this.init();
            }

            init() {
                this.size = 6 + (Math.floor(this.level / 2) * 2);
                if (this.size > 10) this.size = 10;

                this.generateLevel(this.size);

                this.state = this.initial.map(r => [...r]);
                this.render();
                document.getElementById('overlay').classList.remove('show');
            }

            generateLevel(size) {
                // 1. Generate FULL valid solution
                const solution = this.solveBinary(size);

                // 2. Hide cells (Create puzzle)
                // Keeping approx 40-50% filled for solvability
                this.initial = solution.map(row =>
                    row.map(val => (this.rng || Math.random)() > 0.6 ? val : 0)
                );
            }

            solveBinary(n) {
                const board = Array(n).fill(0).map(() => Array(n).fill(0));
                if (this.backtrack(board, 0, 0, n)) return board;
                return Array(n).fill(0).map(() => Array(n).fill(1)); // Fallback
            }

            backtrack(board, r, c, n) {
                if (r === n) return true; // Done

                const nextR = c === n - 1 ? r + 1 : r;
                const nextC = c === n - 1 ? 0 : c + 1;

                // Randomize 1 or 2 (mapped to 0/1 logic later, but here 1=Blue, 2=Pink)
                const values = (this.rng || Math.random)() > 0.5 ? [1, 2] : [2, 1];

                for (const v of values) {
                    if (this.isValid(board, r, c, v, n)) {
                        board[r][c] = v;
                        if (this.backtrack(board, nextR, nextC, n)) return true;
                        board[r][c] = 0;
                    }
                }
                return false;
            }

            isValid(board, r, c, v, n) {
                // 1. Max 2 same sequence
                if (c >= 2 && board[r][c - 1] === v && board[r][c - 2] === v) return false;
                if (r >= 2 && board[r - 1][c] === v && board[r - 2][c] === v) return false;

                // 2. Equal count (n/2)
                let rowCount = 0;
                for (let i = 0; i < c; i++) if (board[r][i] === v) rowCount++;
                if (rowCount >= n / 2) return false;

                let colCount = 0;
                for (let i = 0; i < r; i++) if (board[i][c] === v) colCount++;
                if (colCount >= n / 2) return false;

                return true;
            }
            render() {
                this.board.style.gridTemplateColumns = `repeat(${this.size}, 44px)`;
                this.board.innerHTML = '';
                this.state.forEach((row, y) => {
                    row.forEach((val, x) => {
                        const el = document.createElement('div'); el.className = 'cell';
                        if (this.initial[y][x] !== 0) el.classList.add('fixed');
                        if (val === 1) { el.textContent = '0'; el.classList.add('val-0'); }
                        if (val === 2) { el.textContent = '1'; el.classList.add('val-1'); }
                        el.onclick = () => this.click(x, y); this.board.appendChild(el);
                    });
                });
                this.validate();
            }
            click(x, y) {
                if (this.initial[y][x] !== 0) return;
                let val = this.state[y][x]; val = (val + 1) > 2 ? 0 : val + 1; this.state[y][x] = val;
                this.render();
                if (this.checkWin()) {
                    if (!window.sessionWins) window.sessionWins = 0;
                    window.sessionWins++;
                    if (window.confetti) window.confetti.celebrate();
                    if (window.SoundManager) window.SoundManager.play('win');
                    document.getElementById('overlay').classList.add('show');
                }
            }
            validate() {
                const mark = (x, y) => this.board.children[y * this.size + x].classList.add('error');
                for (let y = 0; y < this.size; y++) for (let x = 0; x < this.size; x++) {
                    const v = this.state[y][x]; if (v === 0) continue;
                    if (x + 2 < this.size && this.state[y][x + 1] === v && this.state[y][x + 2] === v) { mark(x, y); mark(x + 1, y); mark(x + 2, y); }
                    if (y + 2 < this.size && this.state[y + 1][x] === v && this.state[y + 2][x] === v) { mark(x, y); mark(x, y + 1); mark(x, y + 2); }
                }
            }
            checkWin() {
                if (this.state.flat().some(v => v === 0)) return false;
                for (let i = 0; i < this.size; i++) {
                    if (this.state[i].filter(v => v === 1).length !== this.size / 2) return false;
                    if (this.state.map(r => r[i]).filter(v => v === 1).length !== this.size / 2) return false;
                }
                return !document.querySelector('.error');
            }
            next() { this.level++; this.init(); }
            saveAndExit() {
                const dailyParam = this.mode === 'daily' ? '&daily=true' : '';
                window.location.href = `../index.html?save=binary&wins=${window.sessionWins || 1}&time=0${dailyParam}`;
            }
        }
        const game = new BinaryGame();
        window.game = game;
    </script>
    <script src="../js/confetti.js"></script>
</body>

</html>