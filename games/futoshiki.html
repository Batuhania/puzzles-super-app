<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futoshiki - Bulmaca Super App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/main.css">
    <script src="../js/sound.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/theme.js"></script>
    <style>
        /* Use main.css variables */
        body {
            background: var(--bg-app);
            color: var(--text-main);
            min-height: 100vh;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            position: sticky;
            top: 0;
            background: var(--bg-app);
            z-index: 50;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border-radius: 12px;
            color: var(--text-main);
            text-decoration: none;
            font-size: 1.25rem;
            border: 1px solid var(--border);
        }

        .game-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .game-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Futoshiki Grid */
        #board {
            display: grid;
            margin: 1.5rem auto;
            width: 100%;
            max-width: 350px;
        }

        .futoshiki-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid var(--border);
            border-radius: 8px;
        }

        .futoshiki-cell:hover {
            background: #2d3a4f;
        }

        .futoshiki-cell.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .futoshiki-cell.given {
            color: var(--text-muted);
            cursor: default;
        }

        /* Inequality symbols */
        .ineq-h,
        .ineq-v {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 700;
            color: #f97316;
        }

        .ineq-h {
            width: 20px;
        }

        .ineq-v {
            height: 20px;
            transform: rotate(90deg);
        }

        /* Numpad */
        .numpad {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 1.5rem;
        }

        .numpad-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            color: var(--text);
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
        }

        .numpad-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .numpad-btn.clear {
            background: #7f1d1d;
            border-color: #991b1b;
            color: #fca5a5;
        }

        /* Difficulty selector */
        .diff-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 1rem;
        }

        .diff-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .diff-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Win Modal */
        .win-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .win-modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .win-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 1.5rem;
            text-align: center;
            max-width: 320px;
            border: 1px solid var(--border);
        }

        .win-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .win-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .win-text {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        .win-btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            background: var(--primary);
            color: white;
            font-weight: 700;
            text-decoration: none;
            margin-bottom: 0.5rem;
            border: none;
            cursor: pointer;
        }

        .win-btn.secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }

        /* Tutorial Modal */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>

<body class="dark">
    <header class="game-header">
        <a href="../index.html" class="back-btn">←</a>
        <div class="game-title">⚖️ Futoshiki</div>
        <div class="game-actions">
            <button class="back-btn" onclick="openTutorial()">❓</button>
        </div>
    </header>

    <main class="game-container">
        <!-- Mode Selector -->
        <div class="mode-selector">
            <button id="btn-random" class="mode-btn random active" onclick="game.newGame('random')"
                data-i18n="btn_random">🎲 Rastgele</button>
            <button id="btn-daily" class="mode-btn daily" onclick="game.newGame('daily')" data-i18n="btn_daily">📅
                Günlük</button>
        </div>

        <!-- Daily Badge -->
        <div id="daily-badge" class="daily-mode-badge" style="display: none;" data-i18n="daily_puzzle_badge">📅 GÜNLÜK
            BULMACA</div>

        <!-- Difficulty Selector -->
        <div class="diff-selector">
            <button class="diff-btn active" onclick="game.setDifficulty('easy', this)">4×4</button>
            <button class="diff-btn" onclick="game.setDifficulty('medium', this)">5×5</button>
            <button class="diff-btn" onclick="game.setDifficulty('hard', this)">6×6</button>
        </div>

        <!-- Game Board -->
        <div id="board"></div>

        <!-- Numpad -->
        <div class="numpad" id="numpad"></div>
    </main>

    <!-- Tutorial Modal -->
    <div id="tutorialOverlay" class="overlay">
        <div class="win-content">
            <div class="win-icon">⚖️</div>
            <h2 data-i18n="tutorial_title">Nasıl Oynanır?</h2>
            <div class="text-left text-sm" style="color: var(--text-muted); margin-bottom: 1.5rem;">
                <p data-i18n="tut_futoshiki_1" style="margin-bottom: 0.5rem;">1. Her satır ve sütunda rakamlar
                    <strong>tekrar etmemeli</strong>.
                </p>
                <p data-i18n="tut_futoshiki_2" style="margin-bottom: 0.5rem;">2. Hücreler arasındaki
                    <strong>&lt;</strong> ve <strong>&gt;</strong>
                    işaretlerine dikkat et.
                </p>
                <p data-i18n="tut_futoshiki_3" style="margin-bottom: 0.5rem;">3. Büyüklük-küçüklük kurallarına uy.</p>
                <p data-i18n="tut_futoshiki_4" style="margin-bottom: 0.5rem;">4. Örnek: 2 &lt; 4 doğru, 4 &lt; 2 yanlış.
                </p>
            </div>
            <button class="win-btn" onclick="closeTutorial()" data-i18n="btn_understood">Anladım</button>
        </div>
    </div>

    <!-- Win Modal -->
    <div id="winModal" class="win-modal">
        <div class="win-content">
            <div class="win-icon">🎉</div>
            <h2 class="win-title" data-i18n="congrats">Tebrikler!</h2>
            <p class="win-text">Bulmacayı çözdün!</p>
            <a id="winBtn" href="../index.html" class="win-btn" data-i18n="btn_home">Ana Menü</a>
            <button class="win-btn secondary" onclick="game.newGame(game.mode)" data-i18n="btn_new_game">Yeni
                Oyun</button>
        </div>
    </div>

    <script>
        // Tutorial
        function openTutorial() { document.getElementById('tutorialOverlay').classList.add('show'); }
        function closeTutorial() {
            document.getElementById('tutorialOverlay').classList.remove('show');
            localStorage.setItem('seen_tut_futoshiki', 'true');
        }
        if (!localStorage.getItem('seen_tut_futoshiki')) setTimeout(openTutorial, 500);

        // Seeded Random
        class SeededRandom {
            constructor(seed) { this.seed = seed; }
            next() {
                this.seed = (this.seed * 1103515245 + 12345) & 0x7fffffff;
                return this.seed / 0x7fffffff;
            }
            nextInt(min, max) { return Math.floor(this.next() * (max - min + 1)) + min; }
            static getDailySeed() {
                const d = new Date();
                return d.getFullYear() * 10000 + (d.getMonth() + 1) * 100 + d.getDate();
            }
        }

        // Predefined Puzzles
        const PUZZLES = {
            easy: [
                {
                    size: 4,
                    solution: [
                        [2, 1, 4, 3],
                        [4, 3, 2, 1],
                        [1, 4, 3, 2],
                        [3, 2, 1, 4]
                    ],
                    inequalities: [
                        { r1: 0, c1: 0, r2: 0, c2: 1, dir: 'h', op: '>' },
                        { r1: 0, c1: 2, r2: 0, c2: 3, dir: 'h', op: '>' },
                        { r1: 1, c1: 0, r2: 1, c2: 1, dir: 'h', op: '>' },
                        { r1: 2, c1: 1, r2: 2, c2: 2, dir: 'h', op: '>' },
                        { r1: 0, c1: 0, r2: 1, c2: 0, dir: 'v', op: '<' },
                        { r1: 2, c1: 3, r2: 3, c2: 3, dir: 'v', op: '<' }
                    ],
                    given: [[0, 1]]
                },
                {
                    size: 4,
                    solution: [
                        [1, 4, 3, 2],
                        [3, 2, 1, 4],
                        [4, 1, 2, 3],
                        [2, 3, 4, 1]
                    ],
                    inequalities: [
                        { r1: 0, c1: 0, r2: 0, c2: 1, dir: 'h', op: '<' },
                        { r1: 1, c1: 2, r2: 1, c2: 3, dir: 'h', op: '<' },
                        { r1: 2, c1: 0, r2: 2, c2: 1, dir: 'h', op: '>' },
                        { r1: 3, c1: 1, r2: 3, c2: 2, dir: 'h', op: '<' },
                        { r1: 0, c1: 2, r2: 1, c2: 2, dir: 'v', op: '>' },
                        { r1: 1, c1: 1, r2: 2, c2: 1, dir: 'v', op: '>' }
                    ],
                    given: [[2, 0]]
                },
                {
                    size: 4,
                    solution: [
                        [3, 2, 4, 1],
                        [1, 4, 2, 3],
                        [2, 3, 1, 4],
                        [4, 1, 3, 2]
                    ],
                    inequalities: [
                        { r1: 0, c1: 0, r2: 0, c2: 1, dir: 'h', op: '>' },
                        { r1: 0, c1: 2, r2: 0, c2: 3, dir: 'h', op: '>' },
                        { r1: 2, c1: 0, r2: 2, c2: 1, dir: 'h', op: '<' },
                        { r1: 3, c1: 2, r2: 3, c2: 3, dir: 'h', op: '>' },
                        { r1: 0, c1: 3, r2: 1, c2: 3, dir: 'v', op: '<' },
                        { r1: 2, c1: 1, r2: 3, c2: 1, dir: 'v', op: '>' }
                    ],
                    given: [[1, 1]]
                }
            ],
            medium: [
                {
                    size: 5,
                    solution: [
                        [5, 1, 2, 4, 3],
                        [2, 4, 3, 1, 5],
                        [3, 5, 1, 2, 4],
                        [4, 2, 5, 3, 1],
                        [1, 3, 4, 5, 2]
                    ],
                    inequalities: [
                        { r1: 0, c1: 0, r2: 0, c2: 1, dir: 'h', op: '>' },
                        { r1: 0, c1: 3, r2: 0, c2: 4, dir: 'h', op: '>' },
                        { r1: 1, c1: 1, r2: 1, c2: 2, dir: 'h', op: '>' },
                        { r1: 2, c1: 0, r2: 2, c2: 1, dir: 'h', op: '<' },
                        { r1: 3, c1: 2, r2: 3, c2: 3, dir: 'h', op: '>' },
                        { r1: 4, c1: 3, r2: 4, c2: 4, dir: 'h', op: '>' },
                        { r1: 0, c1: 0, r2: 1, c2: 0, dir: 'v', op: '>' },
                        { r1: 1, c1: 2, r2: 2, c2: 2, dir: 'v', op: '>' },
                        { r1: 2, c1: 4, r2: 3, c2: 4, dir: 'v', op: '>' }
                    ],
                    given: [[0, 2], [4, 0]]
                },
                {
                    size: 5,
                    solution: [
                        [3, 5, 1, 4, 2],
                        [4, 1, 2, 3, 5],
                        [2, 4, 5, 1, 3],
                        [5, 3, 4, 2, 1],
                        [1, 2, 3, 5, 4]
                    ],
                    inequalities: [
                        { r1: 0, c1: 0, r2: 0, c2: 1, dir: 'h', op: '<' },
                        { r1: 1, c1: 0, r2: 1, c2: 1, dir: 'h', op: '>' },
                        { r1: 2, c1: 1, r2: 2, c2: 2, dir: 'h', op: '<' },
                        { r1: 3, c1: 2, r2: 3, c2: 3, dir: 'h', op: '>' },
                        { r1: 4, c1: 3, r2: 4, c2: 4, dir: 'h', op: '>' },
                        { r1: 0, c1: 1, r2: 1, c2: 1, dir: 'v', op: '>' },
                        { r1: 1, c1: 3, r2: 2, c2: 3, dir: 'v', op: '>' },
                        { r1: 3, c1: 0, r2: 4, c2: 0, dir: 'v', op: '>' }
                    ],
                    given: [[2, 2], [3, 4]]
                }
            ],
            hard: [
                {
                    size: 6,
                    solution: [
                        [5, 6, 4, 1, 2, 3],
                        [2, 3, 1, 6, 4, 5],
                        [1, 4, 5, 2, 3, 6],
                        [3, 5, 6, 4, 1, 2],
                        [6, 1, 2, 3, 5, 4],
                        [4, 2, 3, 5, 6, 1]
                    ],
                    inequalities: [
                        { r1: 0, c1: 0, r2: 0, c2: 1, dir: 'h', op: '<' },
                        { r1: 0, c1: 2, r2: 0, c2: 3, dir: 'h', op: '>' },
                        { r1: 1, c1: 1, r2: 1, c2: 2, dir: 'h', op: '>' },
                        { r1: 1, c1: 4, r2: 1, c2: 5, dir: 'h', op: '<' },
                        { r1: 2, c1: 3, r2: 2, c2: 4, dir: 'h', op: '<' },
                        { r1: 3, c1: 0, r2: 3, c2: 1, dir: 'h', op: '<' },
                        { r1: 4, c1: 2, r2: 4, c2: 3, dir: 'h', op: '<' },
                        { r1: 5, c1: 4, r2: 5, c2: 5, dir: 'h', op: '>' },
                        { r1: 0, c1: 0, r2: 1, c2: 0, dir: 'v', op: '>' },
                        { r1: 1, c1: 5, r2: 2, c2: 5, dir: 'v', op: '<' },
                        { r1: 2, c1: 2, r2: 3, c2: 2, dir: 'v', op: '<' },
                        { r1: 3, c1: 4, r2: 4, c2: 4, dir: 'v', op: '<' },
                        { r1: 4, c1: 1, r2: 5, c2: 1, dir: 'v', op: '<' }
                    ],
                    given: [[0, 3], [2, 0], [5, 5]]
                }
            ]
        };

        // Game Object
        const game = {
            size: 4,
            difficulty: 'easy',
            mode: 'random',
            selected: null,
            userGrid: [],
            puzzle: null,
            rng: null,

            init() {
                this.newGame('random');
            },

            setDifficulty(diff, btn) {
                this.difficulty = diff;
                document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.newGame(this.mode);
            },

            newGame(mode) {
                this.mode = mode;
                this.selected = null;

                // Update mode buttons
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                if (mode === 'daily') {
                    document.getElementById('btn-daily').classList.add('active');
                    document.getElementById('daily-badge').style.display = 'inline-flex';
                    const seed = SeededRandom.getDailySeed();
                    this.rng = new SeededRandom(seed);
                    document.getElementById('daily-badge').textContent = `📅 ${getText('daily_puzzle_badge')} #${seed % 1000}`;
                } else {
                    document.getElementById('btn-random').classList.add('active');
                    document.getElementById('daily-badge').style.display = 'none';
                    this.rng = new SeededRandom(Date.now());
                }

                // Pick puzzle
                const puzzles = PUZZLES[this.difficulty];
                const puzzleIndex = this.rng.nextInt(0, puzzles.length - 1);
                this.puzzle = puzzles[puzzleIndex];
                this.size = this.puzzle.size;

                // Initialize user grid with given cells
                this.userGrid = Array(this.size).fill(0).map(() => Array(this.size).fill(0));
                if (this.puzzle.given) {
                    this.puzzle.given.forEach(([r, c]) => {
                        this.userGrid[r][c] = this.puzzle.solution[r][c];
                    });
                }

                this.render();
                this.renderNumpad();
                document.getElementById('winModal').classList.remove('show');
            },

            render() {
                const board = document.getElementById('board');
                board.innerHTML = '';

                // Grid needs cells + inequality slots
                // For size N: we have N cells + (N-1) ineq slots horizontally = 2N-1 columns
                const gridSize = this.size * 2 - 1;
                board.style.display = 'grid';
                board.style.gridTemplateColumns = `repeat(${gridSize}, auto)`;
                board.style.gap = '0';

                // Create inequality lookup maps
                const hIneq = {}; // horizontal: between (r,c) and (r,c+1)
                const vIneq = {}; // vertical: between (r,c) and (r+1,c)

                this.puzzle.inequalities.forEach(ineq => {
                    if (ineq.dir === 'h') {
                        hIneq[`${ineq.r1},${ineq.c1}`] = ineq.op;
                    } else {
                        vIneq[`${ineq.r1},${ineq.c1}`] = ineq.op;
                    }
                });

                for (let gr = 0; gr < gridSize; gr++) {
                    for (let gc = 0; gc < gridSize; gc++) {
                        const isCell = gr % 2 === 0 && gc % 2 === 0;
                        const isHIneq = gr % 2 === 0 && gc % 2 === 1;
                        const isVIneq = gr % 2 === 1 && gc % 2 === 0;

                        if (isCell) {
                            const r = gr / 2;
                            const c = gc / 2;
                            const cell = document.createElement('div');
                            cell.className = 'futoshiki-cell';

                            const val = this.userGrid[r][c];
                            cell.textContent = val > 0 ? val : '';

                            // Check if given
                            const isGiven = this.puzzle.given?.some(([gr, gc]) => gr === r && gc === c);
                            if (isGiven) {
                                cell.classList.add('given');
                            }

                            // Selection
                            if (this.selected && this.selected.r === r && this.selected.c === c) {
                                cell.classList.add('selected');
                            }

                            if (!isGiven) {
                                cell.onclick = () => this.selectCell(r, c);
                            }

                            board.appendChild(cell);
                        } else if (isHIneq) {
                            const r = gr / 2;
                            const c = (gc - 1) / 2;
                            const ineqEl = document.createElement('div');
                            ineqEl.className = 'ineq-h';
                            ineqEl.textContent = hIneq[`${r},${c}`] || '';
                            board.appendChild(ineqEl);
                        } else if (isVIneq) {
                            const r = (gr - 1) / 2;
                            const c = gc / 2;
                            const ineqEl = document.createElement('div');
                            ineqEl.className = 'ineq-v';
                            ineqEl.textContent = vIneq[`${r},${c}`] || '';
                            board.appendChild(ineqEl);
                        } else {
                            // Corner spacer
                            const spacer = document.createElement('div');
                            spacer.style.width = '20px';
                            spacer.style.height = '20px';
                            board.appendChild(spacer);
                        }
                    }
                }
            },

            renderNumpad() {
                const numpad = document.getElementById('numpad');
                numpad.innerHTML = '';

                for (let i = 1; i <= this.size; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'numpad-btn';
                    btn.textContent = i;
                    btn.onclick = () => this.input(i);
                    numpad.appendChild(btn);
                }

                // Clear button
                const clearBtn = document.createElement('button');
                clearBtn.className = 'numpad-btn clear';
                clearBtn.innerHTML = '✕';
                clearBtn.onclick = () => this.input(0);
                numpad.appendChild(clearBtn);
            },

            selectCell(r, c) {
                this.selected = { r, c };
                this.render();
                if (window.SoundManager) window.SoundManager.play('click');
            },

            input(num) {
                if (!this.selected) return;
                const { r, c } = this.selected;

                // Check if given
                const isGiven = this.puzzle.given?.some(([gr, gc]) => gr === r && gc === c);
                if (isGiven) return;

                this.userGrid[r][c] = num;
                if (window.SoundManager) window.SoundManager.play('move');
                this.render();
                this.checkWin();
            },

            checkWin() {
                // 1. Check if board is fully filled
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        if (this.userGrid[r][c] === 0) return false;
                    }
                }

                // 2. Check Rows and Columns (Latin Square)
                for (let i = 0; i < this.size; i++) {
                    const rowSet = new Set();
                    const colSet = new Set();
                    for (let j = 0; j < this.size; j++) {
                        rowSet.add(this.userGrid[i][j]);
                        colSet.add(this.userGrid[j][i]);
                    }
                    if (rowSet.size !== this.size || colSet.size !== this.size) return false;
                }

                // 3. Check Inequality Constraints
                for (let ineq of this.puzzle.inequalities) {
                    const val1 = this.userGrid[ineq.r1][ineq.c1];
                    const val2 = this.userGrid[ineq.r2][ineq.c2];
                    if (ineq.op === '>' && !(val1 > val2)) return false;
                    if (ineq.op === '<' && !(val1 < val2)) return false;
                }

                this.win();
                return true;
            },

            win() {
                if (window.SoundManager) window.SoundManager.play('win');
                if (window.confetti) window.confetti.celebrate();

                document.getElementById('winModal').classList.add('show');

                // Update win button URL
                const winBtn = document.getElementById('winBtn');
                winBtn.href = `../index.html?save=futoshiki&wins=1&daily=${this.mode === 'daily'}`;
            }
        };

        window.game = game;
        game.init();
    </script>
    <script src="../js/confetti.js"></script>
</body>

</html>