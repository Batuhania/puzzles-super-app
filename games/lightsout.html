<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lights Out - Bulmaca Super App</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/confetti.css">

    <!-- Scripts -->
    <script src="../js/theme.js"></script>
    <script src="../js/sound.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/random.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        darker: '#020617',
                        primary: '#3b82f6', // Blue theme
                        accent: '#f59e0b',
                        'cell-on': '#fbbf24', // Amber-400
                        'cell-off': '#334155' // Slate-700
                    }
                }
            }
        }
    </script>
    <style>
        .game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            max-width: 350px;
            margin: 0 auto;
            aspect-ratio: 1;
        }

        .cell {
            background-color: var(--cell-off, #334155);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .cell.on {
            background-color: #fbbf24;
            box-shadow: 0 0 15px #fbbf24, inset 0 2px 4px rgba(255, 255, 255, 0.5);
            transform: scale(0.95);
        }

        .cell:active {
            transform: scale(0.9);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 9999;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>

<body
    class="bg-gray-50 dark:bg-darker text-gray-800 dark:text-gray-100 min-h-screen flex flex-col font-['Inter'] transition-colors duration-300 select-none">

    <!-- Header -->
    <header
        class="p-4 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-white/80 dark:bg-dark/80 backdrop-blur-sm sticky top-0 z-10">
        <a href="../index.html" class="flex items-center gap-2 group">
            <div
                class="w-8 h-8 rounded-lg bg-primary/10 text-primary flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-all">
                ←</div>
            <h1 class="font-bold text-lg tracking-tight" data-i18n="game_lightsout">Işıklar Söndür</h1>
        </a>
        <div class="flex items-center gap-3">
            <button onclick="LightsOut.showTutorial()"
                class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center font-bold text-gray-500 hover:bg-gray-300 dark:hover:bg-gray-600 transition">?</button>
            <div id="moveCount" class="font-mono text-xl font-bold text-primary">0</div>
            <div class="text-xs text-gray-500 uppercase tracking-wider font-semibold" data-i18n="label_moves">Hamle
            </div>
        </div>
    </header>

    <!-- Controls -->
    </div>
    <button id="resetBtn" onclick="LightsOut.reset()"
        class="w-12 h-12 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition"
        title="Yeniden Başlat">
        ↺
    </button>
    </div>

    <!-- Game Board -->
    <main class="flex-1 flex flex-col justify-start p-4 items-center">

        <div class="mode-selector">
            <button id="btn-random" class="mode-btn random active" onclick="LightsOut.newGame('random')"
                data-i18n="btn_random">🎲
                Rastgele</button>
            <button id="btn-daily" class="mode-btn daily" onclick="LightsOut.newGame('daily')" data-i18n="btn_daily">📅
                Günlük</button>
        </div>

        <div id="modeBadge"
            class="mb-4 px-3 py-1 rounded-full text-xs font-bold bg-gray-200 dark:bg-gray-800 text-gray-500">
            <span data-i18n="random_puzzle">RASTGELE</span>
        </div>

        <div id="board" class="game-board w-full">
            <!-- Cells generated by JS -->
        </div>

        <div class="mt-8 text-center text-gray-400 text-sm max-w-xs mx-auto">
            <p data-i18n="lightsout_hint">Bir ışığa tıklamak onu ve komşularını tersine çevirir.</p>
            <p class="mt-2 text-primary" data-i18n="lightsout_goal">Hedef: Tüm ışıkları söndür!</p>
        </div>
    </main>

    <!-- Tutorial Overlay -->
    <div id="tutorialOverlay" class="overlay">
        <div
            class="bg-white dark:bg-gray-900 p-8 rounded-2xl text-center max-w-sm w-full mx-4 shadow-2xl border border-gray-200 dark:border-gray-800">
            <div class="text-4xl mb-4">💡</div>
            <h2 data-i18n="tutorial_title">Nasıl Oynanır?</h2>
            <div class="text-left text-sm text-gray-500 dark:text-gray-400 space-y-3 mb-6">
                <p data-i18n="tut_lightsout_1">1. Bir ışığa tıkladığında <strong>hem o ışık hem de komşuları</strong>
                    (sağ, sol, üst, alt) tersine
                    döner.</p>
                <li data-i18n="tut_memory_4">Tüm kartları en az hamlede eşleştirmeye çalış!</li>anlar açılır.</p>
                <p data-i18n="tut_lightsout_3">3. Amacın <strong>tüm ışıkları söndürmek</strong>.</p>
            </div>
            <button onclick="document.getElementById('tutorialOverlay').classList.remove('show')"
                class="w-full py-3 rounded-xl bg-primary hover:bg-blue-600 text-white font-bold transition"
                data-i18n="btn_understood">Anladım</button>
        </div>
    </div>

    <!-- Win Overlay -->
    <div id="winOverlay" class="overlay">
        <div
            class="bg-white dark:bg-gray-900 p-8 rounded-2xl text-center max-w-sm w-full mx-4 shadow-2xl border border-gray-200 dark:border-gray-800 transform scale-95 transition-transform duration-300">
            <div class="text-6xl mb-4">💡</div>
            <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">Harika!</h2>
            <p class="text-gray-500 mb-6">Tüm ışıkları söndürdün.</p>

            <div class="bg-gray-100 dark:bg-gray-800 rounded-xl p-4 mb-6 grid grid-cols-2 gap-4">
                <div>
                    <div class="text-gray-500 text-xs uppercase" data-i18n="label_moves">Hamle</div>
                    <div id="winMoves" class="text-2xl font-bold text-primary">15</div>
                </div>
                <div>
                    <div class="text-gray-500 text-xs uppercase">Mod</div>
                    <div id="winMode" class="text-xl font-bold text-amber-500">Günlük</div>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <button id="goHomeBtn"
                    class="w-full py-3.5 rounded-xl bg-primary hover:bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 transition">
                    Ana Menü
                </button>
                <button onclick="LightsOut.newGame('random')"
                    class="w-full py-3.5 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold transition">
                    Yeni Oyun
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/confetti.js"></script>
    <script>
        const LightsOut = {
            size: 5,
            grid: [],
            moves: 0,
            mode: 'random', // 'random' or 'daily'
            active: true,

            init() {
                const urlParams = new URLSearchParams(window.location.search);
                const modeParam = urlParams.get('mode');

                this.newGame(modeParam === 'daily' ? 'daily' : 'random');
            },

            showTutorial() {
                document.getElementById('tutorialOverlay').classList.add('show');
            },

            newGame(mode) {
                this.mode = mode;
                this.moves = 0;
                this.active = true;
                this.updateUI();

                // Initialize empty grid (all off)
                this.grid = Array(this.size).fill().map(() => Array(this.size).fill(false));

                // Update Buttons
                const btnRandom = document.getElementById('btn-random');
                const btnDaily = document.getElementById('btn-daily');

                // Reset classes
                if (mode === 'daily') {
                    btnDaily.classList.add('active');
                    btnRandom.classList.remove('active');

                    const seed = SeededRandom.getDailySeed();
                    rng = new SeededRandom(seed);
                    document.getElementById('modeBadge').innerHTML = `📅 ${getText('daily_puzzle_badge')} #${seed % 1000}`;
                    document.getElementById('modeBadge').className = 'mb-4 px-3 py-1 rounded-full text-xs font-bold bg-amber-500 text-white shadow-lg';
                } else {
                    btnRandom.classList.add('active');
                    btnDaily.classList.remove('active');

                    rng = new SeededRandom(Date.now());
                    document.getElementById('modeBadge').textContent = getText('random_puzzle');
                    document.getElementById('modeBadge').className = 'mb-4 px-3 py-1 rounded-full text-xs font-bold bg-gray-200 dark:bg-gray-800 text-gray-500';
                }

                // Generate solvable puzzle by simulating clicks
                // Start from solved state (all off) and click random cells
                // Clicking X times guarantees it's solvable by reversing the clicks
                // Minimum 10, max 30 clicks to ensure difficulty
                const steps = rng.nextInt(15, 30);

                for (let i = 0; i < steps; i++) {
                    const x = rng.nextInt(0, this.size - 1);
                    const y = rng.nextInt(0, this.size - 1);
                    this.toggle(x, y, true); // silent toggle
                }

                // If accidentally solved (super rare), click one more
                if (this.checkWin(true)) {
                    this.toggle(0, 0, true);
                }

                this.render();
                document.getElementById('winOverlay').classList.remove('show');
            },

            reset() {
                // To reset, we need to regenerate the EXACT same board.
                // For 'daily', it's easy (seed is fixed).
                // For 'random', we should have saved the seed or just fail to 'exact' reset.
                // Simplest: Just call newGame with same mode. 
                // BETTER: For random, just reload page or restart. 
                // Actually, let's just restart the current mode.
                // NOTE: For 'random', this generates a NEW puzzle. Truly resetting 'random' requires saving seed.
                // Let's keep it simple: Reset = New Game for random. Restart for Daily.
                this.newGame(this.mode);
            },

            toggle(x, y, silent = false) {
                const moves = [
                    [0, 0], [0, 1], [0, -1], [1, 0], [-1, 0]
                ];

                moves.forEach(([dx, dy]) => {
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx >= 0 && nx < this.size && ny >= 0 && ny < this.size) {
                        this.grid[ny][nx] = !this.grid[ny][nx];
                    }
                });

                if (!silent) {
                    if (window.SoundManager) window.SoundManager.play('click');

                    // Specific sound for 'off'? Maybe just click is fine.
                    // Visual feedback is handled by render
                }
            },

            handleClick(x, y) {
                if (!this.active) return;

                this.moves++;
                this.toggle(x, y);
                this.render();

                if (this.checkWin()) {
                    this.gameOver();
                }
            },

            checkWin(silent = false) {
                return this.grid.every(row => row.every(cell => !cell));
            },

            gameOver() {
                this.active = false;
                if (window.SoundManager) window.SoundManager.play('win');
                if (window.confetti) window.confetti.celebrate();

                document.getElementById('winMoves').textContent = this.moves;
                document.getElementById('winMode').textContent = this.mode === 'daily' ? 'Günlük' : 'Rastgele';
                document.getElementById('winOverlay').classList.add('show');

                // Build save URL with daily flag
                const saveUrl = `../index.html?save=lightsout&wins=1&time=${this.moves}&daily=${this.mode === 'daily'}`;
                document.getElementById('goHomeBtn').onclick = () => window.location.href = saveUrl;
            },

            render() {
                const board = document.getElementById('board');
                board.innerHTML = '';

                this.grid.forEach((row, y) => {
                    row.forEach((cell, x) => {
                        const el = document.createElement('div');
                        el.className = `cell ${cell ? 'on' : ''}`;
                        el.onclick = () => this.handleClick(x, y);
                        // Add ripple effect or animation delay
                        board.appendChild(el);
                    });
                });

                document.getElementById('moveCount').textContent = this.moves;
            },

            updateUI() {
                document.getElementById('winOverlay').classList.remove('show');
            }
        };

        // Start
        window.LightsOut = LightsOut;
        LightsOut.init();
    </script>
</body>

</html>