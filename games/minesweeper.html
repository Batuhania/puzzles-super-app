<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mayın Tarlası - Bulmaca Super App</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/confetti.css">
    <script src="../js/theme.js"></script>
    <script src="../js/sound.js"></script>
    <script src="../js/i18n.js"></script>
    <style>
        .minesweeper-board {
            display: grid;
            gap: 2px;
            background: rgba(30, 30, 40, 0.8);
            padding: 4px;
            border-radius: 8px;
            user-select: none;
            margin: 0 auto;
        }

        .cell {
            width: 34px;
            height: 34px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .cell.revealed {
            background: rgba(0, 0, 0, 0.3);
        }

        .cell.flag {
            background: rgba(255, 255, 0, 0.1);
            border: 1px solid rgba(255, 255, 0, 0.3);
        }

        .toggle-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: #888;
            padding: 10px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-btn.active {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .mode-icon {
            font-size: 1.2rem;
        }
    </style>
</head>

<body>
    <header class="game-header">
        <a href="../index.html" class="back-btn">←</a>
        <div class="game-actions">
            <button class="action-btn" onclick="openTutorial()">❓</button>
        </div>
    </header>

    <main class="game-container">
        <div class="mode-selector">
            <button id="btn-random" class="mode-btn random active" onclick="game.newGame('random')"
                data-i18n="btn_random">🎲 Rastgele</button>
            <button id="btn-daily" class="mode-btn daily" onclick="game.newGame('daily')" data-i18n="btn_daily">📅
                Günlük</button>
        </div>
        <!-- Daily Mode Badge -->
        <div id="daily-badge" class="daily-mode-badge" style="display: none;" data-i18n="daily_puzzle_badge">📅 GÜNLÜK
            BULMACA</div>

        <button class="toggle-btn" id="modeBtn" onclick="game.toggleMode()">
            <span class="mode-icon">⛏️</span> <span id="modeText">KAZMA MODU</span>
        </button>

        <div class="minesweeper-board" id="board"></div>
        <p style="text-align:center; margin-top:10px; color:#666;">Bayrak koymak için butona bas veya sağ tıkla</p>
    </main>

    <div class="win-overlay" id="overlay">
        <div class="win-modal" style="padding: 2rem; text-align: center;">
            <h2 id="endMsg" style="margin-bottom: 1.5rem;"></h2>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="win-btn" onclick="game.init()"
                    style="background: #3b82f6; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none;"
                    data-i18n="btn_play_again">Tekrar
                    Oyna</button>
                <button onclick="game.saveAndExit()"
                    style="background: #10b981; color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; border: 2px solid white;"
                    data-i18n="btn_save_exit">Kaydet ve Ana Menüye Dön</button>
            </div>
        </div>
    </div>

    <script>
        function saveAndExit() {
            const dailyParam = window.minesweeperMode === 'daily' ? '&daily=true' : '';
            window.location.href = `../index.html?save=minesweeper&wins=${window.sessionWins || 0}&time=0${dailyParam}`;
        }

        // Seeded random
        function mulberry32(a) {
            return function () {
                let t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }
        class Minesweeper {
            constructor() {
                this.rows = 10; this.cols = 10; this.mines = 12;
                this.mode = 'dig'; // dig | flag
                this.btn = document.getElementById('modeBtn');
                this.board = document.getElementById('board');
                this.init();
            }

            newGame(mode) {
                window.minesweeperMode = mode;

                // Update UI Buttons
                document.querySelectorAll('.action-btn').forEach(btn => {
                    if (btn.id) btn.classList.remove('active');
                });

                const btnRandom = document.getElementById('btn-random');
                const btnDaily = document.getElementById('btn-daily');

                if (mode === 'daily') {
                    btnDaily.classList.add('active');
                    document.getElementById('daily-badge').style.display = 'inline-flex';
                    const today = new Date();
                    const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
                    this.rng = mulberry32(seed);
                    document.getElementById('daily-badge').textContent = `📅 ${getText('daily_puzzle_badge')} #${seed % 1000}`;
                } else {
                    btnRandom.classList.add('active');
                    document.getElementById('daily-badge').style.display = 'none';
                    this.rng = Math.random;
                }
                this.init();
            }

            init() {
                this.grid = Array(10).fill(0).map((_, y) => Array(10).fill(0).map((_, x) => ({ x, y, mine: false, rev: false, flag: false, count: 0 })));
                this.gameOver = false;
                this.first = true;
                this.render();
                document.getElementById('overlay').classList.remove('show');
            }

            toggleMode() {
                this.mode = this.mode === 'dig' ? 'flag' : 'dig';
                this.btn.classList.toggle('active', this.mode === 'flag');
                document.querySelector('.mode-icon').textContent = this.mode === 'flag' ? '🚩' : '⛏️';
                document.getElementById('modeText').textContent = this.mode === 'flag' ? 'BAYRAK MODU' : 'KAZMA MODU';
            }

            render() {
                this.board.style.gridTemplateColumns = `repeat(10, 34px)`;
                this.board.innerHTML = '';
                this.grid.flat().forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'cell';
                    if (c.rev) {
                        el.classList.add('revealed');
                        if (c.mine) el.textContent = '💣';
                        else if (c.count > 0) {
                            el.textContent = c.count;
                            el.style.color = ['#60a5fa', '#34d399', '#f87171', '#818cf8'][c.count - 1] || '#fff';
                        }
                    } else if (c.flag) {
                        el.classList.add('flag');
                        el.textContent = '🚩';
                    }

                    el.onclick = () => this.click(c);
                    el.oncontextmenu = (e) => { e.preventDefault(); this.flag(c); };
                    this.board.appendChild(el);
                });
            }

            click(c) {
                if (this.gameOver) return;
                if (this.mode === 'flag') { this.flag(c); return; }
                if (c.flag || c.rev) return;

                if (this.first) {
                    this.placeMines(c);
                    this.first = false;
                }

                if (c.mine) {
                    c.rev = true;
                    this.end(false);
                } else {
                    this.reveal(c);
                    if (this.checkWin()) this.end(true);
                }
                this.render();
            }

            flag(c) {
                if (!c.rev) { c.flag = !c.flag; this.render(); }
            }

            reveal(c) {
                if (c.rev || c.flag) return;
                c.rev = true;
                if (c.count === 0) {
                    for (let dy = -1; dy <= 1; dy++) for (let dx = -1; dx <= 1; dx++) {
                        const nx = c.x + dx, ny = c.y + dy;
                        if (this.grid[ny] && this.grid[ny][nx]) this.reveal(this.grid[ny][nx]);
                    }
                }
            }

            placeMines(safe) {
                let placed = 0;
                const rng = this.rng || Math.random;
                while (placed < this.mines) {
                    const x = Math.floor(rng() * 10), y = Math.floor(rng() * 10);
                    if ((Math.abs(x - safe.x) <= 1 && Math.abs(y - safe.y) <= 1) || this.grid[y][x].mine) continue;
                    this.grid[y][x].mine = true;
                    placed++;
                }
                // Counts
                this.grid.flat().forEach(c => {
                    if (!c.mine) {
                        let cnt = 0;
                        for (let dy = -1; dy <= 1; dy++) for (let dx = -1; dx <= 1; dx++) {
                            const nx = c.x + dx, ny = c.y + dy;
                            if (this.grid[ny] && this.grid[ny][nx] && this.grid[ny][nx].mine) cnt++;
                        }
                        c.count = cnt;
                    }
                });
            }

            checkWin() {
                return this.grid.flat().every(c => c.rev || c.mine);
            }

            end(win) {
                this.gameOver = true;
                document.getElementById('endMsg').textContent = win ? 'KAZANDIN!' : 'KAYBETTp\u0130N!';
                document.getElementById('overlay').classList.add('show');
                if (win) {
                    if (!window.sessionWins) window.sessionWins = 0;
                    window.sessionWins++;
                    if (window.confetti) window.confetti.celebrate();
                    if (window.SoundManager) window.SoundManager.play('win');
                }
            }
        }
        const game = new Minesweeper();
        window.game = game;
    </script>
    <script src="../js/confetti.js"></script>
    <!-- TUTORIAL -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-modal">
            <h2 class="tutorial-title" data-i18n="tutorial_title">Nasıl Oynanır?</h2>
            <ul class="tutorial-steps">
                <li data-i18n='tut_minesweeper_1'></li>
                <li data-i18n='tut_minesweeper_2'></li>
                <li data-i18n='tut_minesweeper_3'></li>
                <li data-i18n='tut_minesweeper_4'></li>
            </ul>
            <button class="win-btn" onclick="closeTutorial()" data-i18n="btn_understood">Anladım</button>
        </div>
    </div>
    <script>        function openTutorial() { document.getElementById('tutorialOverlay').classList.add('show'); }
        function closeTutorial() { document.getElementById('tutorialOverlay').classList.remove('show'); localStorage.setItem('seen_tut_minesweeper', 'true'); }
        if (!localStorage.getItem('seen_tut_minesweeper')) setTimeout(openTutorial, 500);</script>
</body>

</html>